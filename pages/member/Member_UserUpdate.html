<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<link type="text/css" rel="stylesheet" href="../../css/style.css"/>
	<script type="text/javascript" src="../../js/vue.js"></script>
	<!-- 引入样式 -->
	<link rel="stylesheet" href="/css/Element.css">
	<!-- 引入组件库 -->
	<script src="/js/Element.js"></script>
</head>
<body>
<!--Begin Header Begin-->
<div id="app">
	<div class="soubg">
		<div class="sou">
			<!--Begin 所在收货地区 Begin-->
			<span class="s_city_b">
        	<span class="fl">送货至：</span>
            <span class="s_city">
            	<span>四川</span>
                <div class="s_city_bg">
                	<div class="s_city_t"></div>
                    <div class="s_city_c">
                    	<h2>请选择所在的收货地区</h2>
                        <table border="0" class="c_tab" style="width:235px; margin-top:10px;" cellspacing="0"
							   cellpadding="0">
                          <tr>
                            <th>A</th>
                            <td class="c_h"><span>安徽</span><span>澳门</span></td>
                          </tr>
                          <tr>
                            <th>B</th>
                            <td class="c_h"><span>北京</span></td>
                          </tr>
                          <tr>
                            <th>C</th>
                            <td class="c_h"><span>重庆</span></td>
                          </tr>
                          <tr>
                            <th>F</th>
                            <td class="c_h"><span>福建</span></td>
                          </tr>
                          <tr>
                            <th>G</th>
                            <td class="c_h"><span>广东</span><span>广西</span><span>贵州</span><span>甘肃</span></td>
                          </tr>
                          <tr>
                            <th>H</th>
                            <td class="c_h"><span>河北</span><span>河南</span><span>黑龙江</span><span>海南</span><span>湖北</span><span>湖南</span></td>
                          </tr>
                          <tr>
                            <th>J</th>
                            <td class="c_h"><span>江苏</span><span>吉林</span><span>江西</span></td>
                          </tr>
                          <tr>
                            <th>L</th>
                            <td class="c_h"><span>辽宁</span></td>
                          </tr>
                          <tr>
                            <th>N</th>
                            <td class="c_h"><span>内蒙古</span><span>宁夏</span></td>
                          </tr>
                          <tr>
                            <th>Q</th>
                            <td class="c_h"><span>青海</span></td>
                          </tr>
                          <tr>
                            <th>S</th>
                            <td class="c_h"><span>上海</span><span>山东</span><span>山西</span><span
									class="c_check">四川</span><span>陕西</span></td>
                          </tr>
                          <tr>
                            <th>T</th>
                            <td class="c_h"><span>台湾</span><span>天津</span></td>
                          </tr>
                          <tr>
                            <th>X</th>
                            <td class="c_h"><span>西藏</span><span>香港</span><span>新疆</span></td>
                          </tr>
                          <tr>
                            <th>Y</th>
                            <td class="c_h"><span>云南</span></td>
                          </tr>
                          <tr>
                            <th>Z</th>
                            <td class="c_h"><span>浙江</span></td>
                          </tr>
                        </table>
                    </div>
                </div>
            </span>
        </span>
			<!--End 所在收货地区 End-->
			<span class="fr">
            <span class="fr">
        	<span class="fl" v-if="currentUser.id==undefined">你好，请<a href="../login/Login.html">登录</a>&nbsp;
				<a href="../login/Regist.html" v-if="currentUser.id==undefined" style="color:#ff4e00;">免费注册</a>&nbsp;|&nbsp;
			</span>
				<span class="fl" v-if="currentUser.id>0">
										<el-link class="fl" href="../index/Index.html">首页|&nbsp;</el-link>

										<el-link class="fl" :href=`../member/Member_User.html?id=${currentUser.id}`>个人中心|&nbsp;</el-link>

					<el-link class="fl" @click="exitSystem">退出登陆&nbsp;|</el-link>
									欢迎,{{currentUser.userName}}登录&nbsp;|
				</span>
            <span class="fl">|&nbsp;关注我们：</span>
            <span class="s_sh"><a href="#" class="sh1">新浪</a><a href="#" class="sh2">微信</a></span>
            <span class="fr">|&nbsp;<a href="#">手机版&nbsp;<img src="../../images/s_tel.png"
																 align="absmiddle"/></a></span>
        </span>
		</div>
	</div>
	<div class="m_top_bg">
		<div class="top">
			<div class="m_logo"><a href="../index/Index.html"><img src="../../images/logo1.png"/></a></div>

		</div>
	</div>
	<!--End Header End-->
	<div class="i_bg bg_color">
		<!--Begin 用户中心 Begin -->
		<div class="m_content">
			<div class="m_left">
				<div class="left_n">管理中心</div>
				<div class="left_m" v-if="currentUser.roleId<3 &&currentUser.id>0">
					<div class="left_m_t t_bg1">订单管理</div>
					<ul>
						<li><a href="Member_Order.html">订单列表</a></li>
					</ul>
				</div>
				<div class="left_m" v-if="currentUser.roleId<3 &&currentUser.id>0">
					<div class="left_m_t t_bg2">商品管理</div>
					<ul>
						<li><a href="../member/ProductList.html">商品列表</a></li>
						<li><a href="../member/ProductAdd.html">添加商品</a></li>
					</ul>
				</div>
				<div class="left_m">
					<div class="left_m_t t_bg2">用户中心</div>
					<ul>
						<li v-if="currentUser.roleId<3 &&currentUser.id>0"><a
								href="../member/Member_UserList.html">用户列表</a></li>
						<li v-if="currentUser.roleId<3 &&currentUser.id>0"><a
								href="../member/Member_UserAdd.html">添加用户</a></li>
						<li><a :href=`../member/Member_Collect.html?id=${currentUser.id}`>收藏夹</a></li>
					</ul>
				</div>
				<div class="left_m" v-if="currentUser.roleId<3 &&currentUser.id>0">
					<div class="left_m_t t_bg3">分类管理</div>
					<ul>
						<li><a href="../member/CategoryList.html">分类列表</a></li>
					</ul>
				</div>
				<div class="left_m">
					<div class="left_m_t t_bg4">资讯中心</div>
					<ul>
						<li><a href="../member/Member_NewsList.html">资讯列表</a></li>
						<li v-if="currentUser.roleId<3 &&currentUser.id>0"><a
								href="../member/Member_NewsAdd.html">添加资讯</a></li>
					</ul>
				</div>
			</div>
			<div class="m_right">
				<p></p>
				<div style="margin: 100px;">
					<h1>修改用户信息</h1>
					<div class="pages">
						<el-form :model="user" status-icon :rules="rules" ref="user" label-width="100px"
								 class="demo-ruleForm" v-cloak style="width: 400px">
							<el-form-item label="用户名" prop="loginName">
								<el-input disabled prefix-icon="el-icon-user" clearable type="text"
										  v-model.trim="user.loginName"
										  autocomplete="off">
								</el-input>
							</el-form-item>
							<el-form-item label="真实姓名" prop="userName">
								<el-input prefix-icon="el-icon-user" clearable type="text" v-model.trim="user.userName"
										  autocomplete="off">
								</el-input>
							</el-form-item>
							<el-form-item label="密码" prop="password">
								<el-input prefix-icon="el-icon-unlock" clearable show-password
										  v-model.trim="user.password" autocomplete="off"></el-input>
							</el-form-item>
							<el-form-item label="新密码" prop="confirmPass">
								<el-input prefix-icon="el-icon-unlock" clearable show-password
										  v-model.trim="user.confirmPass" autocomplete="off"></el-input>
							</el-form-item>
							<el-form-item label="身份证号" prop="identityCode">
								<el-input prefix-icon="el-icon-unlock" clearable
										  v-model.trim="user.identityCode" autocomplete="off"></el-input>
							</el-form-item>
							<el-form-item label="邮箱" prop="email">
								<el-input type="text" prefix-icon="el-icon-unlock" clearable v-model.trim="user.email"
										  autocomplete="off"></el-input>
							</el-form-item>
							<el-form-item label="手机" prop="mobile">
								<el-input type="text" prefix-icon="el-icon-unlock" clearable
										  v-model.trim="user.mobile" autocomplete="off"></el-input>
							</el-form-item>
							<el-form-item label="用户类型" prop="roleId">
								<div>
									<select style="float: left;margin-top: +10px;margin-left: 5px"
											v-model="user.roleId">
										<option value="0">请选择</option>
										<option v-if="role.id!=1" autocomplete="off" :value="role.id"
												v-for="(role,index) in roleList" :key="role.id">{{role.roleName}}
										</option>
									</select>
								</div>
							</el-form-item>

							<el-form-item>
								<!-- <el-button type="primary" style="width: 100%" @click="submitForm('user')">登录</el-button> -->

								<input @click.prevent="submitForm('user')" type="submit" value="修改" class="p_pre"/>
								<input type="button" @click="back" value="返回" class="p_pre">

							</el-form-item>
						</el-form>
					</div>
				</div>
			</div>
		</div>
		<!--End 用户中心 End-->
		<!--Begin Footer Begin -->
		<div class="b_btm_bg b_btm_c">
			<div class="b_btm">
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b1.png" width="62" height="62"/></td>
						<td><h2>正品保障</h2>正品行货 放心购买</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b2.png" width="62" height="62"/></td>
						<td><h2>满38包邮</h2>满38包邮 免运费</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b3.png" width="62" height="62"/></td>
						<td><h2>天天低价</h2>天天低价 畅选无忧</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b4.png" width="62" height="62"/></td>
						<td><h2>准时送达</h2>收货时间由你做主</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="b_nav">
			<dl>
				<dt><a href="#">新手上路</a></dt>
				<dd><a href="#">售后流程</a></dd>
				<dd><a href="#">购物流程</a></dd>
				<dd><a href="#">订购方式</a></dd>
				<dd><a href="#">隐私声明</a></dd>
				<dd><a href="#">推荐分享说明</a></dd>
			</dl>
			<dl>
				<dt><a href="#">配送与支付</a></dt>
				<dd><a href="#">货到付款区域</a></dd>
				<dd><a href="#">配送支付查询</a></dd>
				<dd><a href="#">支付方式说明</a></dd>
			</dl>
			<dl>
				<dt><a href="#">会员中心</a></dt>
				<dd><a href="#">资金管理</a></dd>
				<dd><a href="#">我的收藏</a></dd>
				<dd><a href="#">我的订单</a></dd>
			</dl>
			<dl>
				<dt><a href="#">服务保证</a></dt>
				<dd><a href="#">退换货原则</a></dd>
				<dd><a href="#">售后服务保证</a></dd>
				<dd><a href="#">产品质量保证</a></dd>
			</dl>
			<dl>
				<dt><a href="#">联系我们</a></dt>
				<dd><a href="#">网站故障报告</a></dd>
				<dd><a href="#">购物咨询</a></dd>
				<dd><a href="#">投诉与建议</a></dd>
			</dl>
			<div class="b_tel_bg">
				<a href="#" class="b_sh1">新浪微博</a>
				<a href="#" class="b_sh2">腾讯微博</a>
				<p>
					服务热线：<br/>
					<span>400-123-4567</span>
				</p>
			</div>
			<div class="b_er">
				<div class="b_er_c"><img src="../../images/er.gif" width="118" height="118"/></div>
				<img src="../../images/ss.png"/>
			</div>
		</div>
		<div class="btmbg">
			<div class="btm">
				备案/许可证编号：蜀ICP备12009302号-1-www.dingguagua.com Copyright © 2015-2018 尤洪商城网 All Rights
				Reserved. 复制必究 , Technical Support: Dgg Group <br/>
				<img src="../../images/b_1.gif" width="98" height="33"/><img src="../../images/b_2.gif" width="98"
																			 height="33"/><img
					src="../../images/b_3.gif" width="98" height="33"/><img src="../../images/b_4.gif" width="98"
																			height="33"/><img src="../../images/b_5.gif"
																							  width="98"
																							  height="33"/><img
					src="../../images/b_6.gif" width="98" height="33"/>
			</div>
		</div>
		<!--End Footer End -->
	</div>
</div>
</body>
<script src="../../utils/parseCookie.js"></script>

<script type="module">
	import {getUserById, updateUser, exitSystem, getUser,getUserCount,getUserByMobile} from "../../api/user.js";
	import {getRoleList} from "../../api/role.js";

	let params = window.location.search.split("=");
	let id = params[1];
	const vm = new Vue({
		el: '#app',
		data() {
			var validateLoginName = async (rule, value, callback) => {
				if (value == '') {
					callback(new Error('请输入账户'))
					return;
				}
				if (value.length < 3 || value.length > 6) {
					callback(new Error('请3-6位账户名'))
					return;
				}
				const regUserAccount = /^[A-Za-z0-9]{3,6}$/;
				if (!regUserAccount.test(value)) {
					callback(new Error('请输入英文或者数字'));
					return;
				}
				this.loginName = true;
				callback();
			};
			var validateUserName = async (rule, value, callback) => {
				if (value == '') {
					callback(new Error('请输入真实姓名'))
					return;
				}
				if (value.length < 1 || value.length > 10) {
					callback(new Error('请1-10位真实姓名'))
					return;
				}
				const regUserName = /^[\u4e00-\u9fa5a-zA-Z]{1,10}$/;
				if (!regUserName.test(value)) {
					callback(new Error('请输入英文或者中文'));
					return;
				}
				this.loginName = true;
				callback();
			};
			var validateIdentityCode = async (rule, value, callback) => {
				if (value == '') {
					callback(new Error('请输入身份证号码'))
					return;
				}
				if (value.length != 18) {
					callback(new Error('请18位身份证号码'))
					return;
				}
				const regIdentityCode = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
				if (!regIdentityCode.test(value)) {
					callback(new Error('请18位身份证号码'));
					return;
				}
				this.$delete(this.user, 'confirmPass');
				let {data}=await getUserCount(this.user);

				if(data.identityCode!=this.IdentityCode) {
					if (data !=null) {
						callback(new Error('身份证号码已经存在'));
						return;
					}
				}
				this.loginName = true;
				callback();
			};
			var validatePass = (rule, value, callback) => {
				if (value == '') {
					callback(new Error('请再次输入密码'));
				} else if (value.length < 3 || value.length > 6) {
					callback(new Error('请输入3-6位密码'));
				} else {
					this.passwordFlag = true;
					callback();
				}
			};
			var validateConfirmPass = (rule, value, callback) => {
				if (value == '') {
					callback(new Error('请再次输入密码'));
				} else if (value.length < 3 || value.length > 6) {
					callback(new Error('请输入3-6位密码'));
				} /*else if (value == vm.user.password) {
					callback(new Error('不能和原密码相同'));
				}*/ else {
					this.confirmPassFlag = true;
					callback();
				}
			};
			var validateEmail = (rule, value, callback) => {
				//验证邮箱的正则表达式
				const regEmail = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
				if (regEmail.test(value)) {
					//合法的邮箱
					this.emailFlag = true;
					return callback();
				}
				callback(new Error("请输入合法的邮箱"));
			};
			var validateMobile = async (rule, value, callback) => {
				const regMobile = /^1[3-9][0-9]{9}$/;
				if (regMobile.test(value)) {
					this.mobileFlag = true;
					return callback();
				}
				this.$delete(this.user, 'confirmPass');
				let {data} = await getUserByMobile(this.user);
				if(data.mobile!=this.Mobile) {
					if (data != null) {
						callback(new Error("该手机号已经被注册！"));
						return;
					}
				}
				callback(new Error("请输入合法的手机号"));
			};
			var validateRoleId = (rule, value, callback) => {
				if (value > 0) {
					this.mobileFlag = true;
					return callback();
				}
				callback(new Error("请选择权限等级"));
			};

			return {
				user: {
					id: '',
					loginName: '',
					password: '',
					email: '',
					mobile: '',
					roleId: 0,

				},
				roleList: [],
				IdentityCode:"",
				Mobile:"",
				verifyCodeMsg: '*',
				inputVerifyCodeFlag: false,
				verifyCode: '',
				showTime: true,
				isIDExist:false,
				isMExist:false,
				getTime: 60,
				timer: '',
				currentUser: {},

				rules: {
					loginName: [{
						required: true,
						message: '请输入账户名',
						trigger: 'blur'
					},
						{
							validator: validateLoginName,
							trigger: 'blur',
						}
					],
					userName: [{
						required: true,
						message: '请输入真实姓名',
						trigger: 'blur'
					},
						{
							validator: validateUserName,
							trigger: 'blur',
						}
					],
					identityCode: [{
						required: true,
						message: '请输入18位的身份证号码',
						trigger: 'blur'
					},
						{
							validator: validateIdentityCode,
							trigger: 'blur',
						}
					],

					password: [{
						required: true,
						message: '请输入密码',
						trigger: 'blur'
					},
						{
							validator: validatePass,
							trigger: 'blur',
						}
					],
					confirmPass: [{
						required: true,
						message: '请输入密码',
						trigger: 'blur'
					},
						{
							validator: validateConfirmPass,
							trigger: 'blur',
						}
					],
					email: [{
						required: true,
						message: '请输入邮箱',
						trigger: 'blur'
					},
						{
							validator: validateEmail,
							trigger: 'blur',
						}
					],
					mobile: [{
						required: true,
						message: '请输入手机号',
						trigger: 'blur'
					},
						{
							validator: validateMobile,
							trigger: 'blur'
						}
					],
					roleId: [{
						required: true,
						message: '请输入角色等级',
						trigger: 'blur'
					},
						{
							validator: validateRoleId,
							trigger: 'blur'
						}
					],
				}
			}
		},
		mounted: async function () {
			this.currentUser = {};
			let roleId = parseCookie("roleId");
			let loginName = parseCookie("loginName");
			if (loginName != null && loginName != '') {
				this.currentUser.loginName = loginName;
				await this.getUser();
			}
			await this.getRoleList();
			this.user.id = id;
			await this.getUserById(this.user);
			this.Mobile = this.user.mobile;
			this.IdentityCode = this.user.identityCode;
		},
		methods: {
			async getRoleList() {
				let response = await getRoleList(this.currentUser);
				this.roleList = response.data;
			},
			async submitForm(formName) {
				this.$refs[formName].validate(async (valid) => {
					if (valid) {
						this.user.password = this.user.confirmPass;
						this.$delete(this.user, 'confirmPass');

						const {code} = (await updateUser(this.user,this.currentUser));
						if (code == "200") {
							this.$message({
								message: "修改成功",
								center: true,
								type: 'success',
							})
							window.location.href = "Member_UserList.html";
						}
					} else {
						return false;
					}
				});
			},
			resetForm(formName) {
				this.$refs[formName].resetFields();
			},
			toLogin() {
				window.location.href = "Login.html";
			},
			back() {
				window.location.href = "Member_UserList.html";
			},
			async getUserById(user) {
				let response = await getUserById(user);
				this.user = response.data;
			},
			async exitSystem() {
				if (confirm("确认退出登录吗?")) {
					const {code} = await exitSystem();
					if (code == "200") {
						// window.location.href = "../login/Login.html"
						window.history.replaceState(null, "", "../login/Login.html");
						window.history.go(0)
						this.user = {};

					}
				}
			},
			async getUser() {
				const {data} = await getUser(this.currentUser);
				this.currentUser = data;
			},

		}
	})
</script>

<!--[if IE 6]>
<script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->
</html>
