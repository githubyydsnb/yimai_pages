<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>商品添加</title>
</head>

<script type="text/javascript" src="/js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>
<script type="text/javascript" src="../../js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="../../js/menu.js"></script>
<link type="text/css" rel="stylesheet" href="../../css/style.css"/>
<script type="text/javascript" src="../../js/select.js"></script>
<script type="text/javascript" src="/js/select.js"></script>
<script type="text/javascript" src="../../js/vue.js"></script>
<!-- 引入样式 -->
<link rel="stylesheet" href="/css/Element.css">
<!-- 引入组件库 -->
<script src="/js/Element.js"></script>

<body>
<!--Begin Header Begin-->
<div id="root">


	<div class="soubg">
		<div class="sou">
			<!--Begin 所在收货地区 Begin-->
			<span class="s_city_b">
        	<span class="fl">送货至：</span>
            <span class="s_city">
            	<span>四川</span>
                <div class="s_city_bg">
                	<div class="s_city_t"></div>
                    <div class="s_city_c">
                    	<h2>请选择所在的收货地区</h2>
                        <table border="0" class="c_tab" style="width:235px; margin-top:10px;" cellspacing="0"
							   cellpadding="0">
                          <tr>
                            <th>A</th>
                            <td class="c_h"><span>安徽</span><span>澳门</span></td>
                          </tr>
                          <tr>
                            <th>B</th>
                            <td class="c_h"><span>北京</span></td>
                          </tr>
                          <tr>
                            <th>C</th>
                            <td class="c_h"><span>重庆</span></td>
                          </tr>
                          <tr>
                            <th>F</th>
                            <td class="c_h"><span>福建</span></td>
                          </tr>
                          <tr>
                            <th>G</th>
                            <td class="c_h"><span>广东</span><span>广西</span><span>贵州</span><span>甘肃</span></td>
                          </tr>
                          <tr>
                            <th>H</th>
                            <td class="c_h"><span>河北</span><span>河南</span><span>黑龙江</span><span>海南</span><span>湖北</span><span>湖南</span></td>
                          </tr>
                          <tr>
                            <th>J</th>
                            <td class="c_h"><span>江苏</span><span>吉林</span><span>江西</span></td>
                          </tr>
                          <tr>
                            <th>L</th>
                            <td class="c_h"><span>辽宁</span></td>
                          </tr>
                          <tr>
                            <th>N</th>
                            <td class="c_h"><span>内蒙古</span><span>宁夏</span></td>
                          </tr>
                          <tr>
                            <th>Q</th>
                            <td class="c_h"><span>青海</span></td>
                          </tr>
                          <tr>
                            <th>S</th>
                            <td class="c_h"><span>上海</span><span>山东</span><span>山西</span><span
									class="c_check">四川</span><span>陕西</span></td>
                          </tr>
                          <tr>
                            <th>T</th>
                            <td class="c_h"><span>台湾</span><span>天津</span></td>
                          </tr>
                          <tr>
                            <th>X</th>
                            <td class="c_h"><span>西藏</span><span>香港</span><span>新疆</span></td>
                          </tr>
                          <tr>
                            <th>Y</th>
                            <td class="c_h"><span>云南</span></td>
                          </tr>
                          <tr>
                            <th>Z</th>
                            <td class="c_h"><span>浙江</span></td>
                          </tr>
                        </table>
                    </div>
                </div>
            </span>
        </span>
			<!--End 所在收货地区 End-->
			<span class="fr">
         <span class="fr">
        	<span class="fl" v-if="user.id==undefined">你好，请<a href="../login/Login.html">登录</a>&nbsp;
				<a href="../login/Regist.html" v-if="user.id==undefined" style="color:#ff4e00;">免费注册</a>&nbsp;|&nbsp;
			</span>
				<span class="fl" v-if="user.id>0">
										<el-link class="fl" href="../index/Index.html">首页|&nbsp;</el-link>

										<el-link class="fl" :href=`../member/Member_User.html?id=${user.id}`>个人中心|&nbsp;</el-link>

					<el-link class="fl" @click="exitSystem">退出登陆&nbsp;|</el-link>
									欢迎,{{user.userName}}登录&nbsp;|
				</span>
            <span class="fl">|&nbsp;关注我们：</span>
            <span class="s_sh"><a href="#" class="sh1">新浪</a><a href="#" class="sh2">微信</a></span>
            <span class="fr">|&nbsp;<a href="#">手机版&nbsp;<img src="../../images/s_tel.png"
																 align="absmiddle"/></a></span>
        </span>
		</div>
	</div>
	<div class="m_top_bg">
		<div class="top">
			<div class="m_logo"><a href="../index/Index.html"><img src="../../images/logo1.png"/></a></div>

		</div>
	</div>
	<!--End Header End-->
	<div class="i_bg bg_color">
		<!--Begin 用户中心 Begin -->
		<div class="m_content">
			<div class="m_left">
				<div class="left_n">管理中心</div>
				<div class="left_m" v-if="user.roleId==3 &&user.id>0">
					<div class="left_m_t t_bg1">订单中心</div>
					<ul>
						<li><a :href=`Member_UserOrder.html?id=${user.id}`>我的订单</a></li>
						<li><a :href=`Member_Address.html?id=${user.id}`>收货地址</a></li>
					</ul>
				</div>
				<div class="left_m" v-if="user.roleId<3 &&user.id>0">
					<div class="left_m_t t_bg1">订单管理</div>
					<ul>
						<li><a href="Member_Order.html">订单列表</a></li>
					</ul>
				</div>
				<div class="left_m" v-if="user.roleId<3 &&user.id>0">
					<div class="left_m_t t_bg2">商品管理</div>
					<ul>
						<li><a href="../member/ProductList.html">商品列表</a></li>
						<li><a href="../member/ProductAdd.html">添加商品</a></li>
					</ul>
				</div>
				<div class="left_m">
					<div class="left_m_t t_bg2">用户中心</div>
					<ul>
						<li v-if="user.roleId<3 &&user.id>0"><a href="../member/Member_UserList.html">用户列表</a></li>
						<li v-if="user.roleId<3 &&user.id>0"><a href="../member/Member_UserAdd.html">添加用户</a></li>
						<li><a :href=`../member/Member_Collect.html?id=${user.id}`>收藏夹</a></li>
					</ul>
				</div>
				<div class="left_m" v-if="user.roleId<3 &&user.id>0">
					<div class="left_m_t t_bg3">分类管理</div>
					<ul>
						<li><a href="../member/CategoryList.html">分类列表</a></li>
					</ul>
				</div>
				<div class="left_m">
					<div class="left_m_t t_bg4">资讯中心</div>
					<ul>
						<li><a href="../member/Member_NewsList.html">资讯列表</a></li>
						<li v-if="user.roleId<3 &&user.id>0"><a href="../member/Member_NewsAdd.html">添加资讯</a></li>
					</ul>
				</div>
			</div>

			<div class="m_right">
				<div align="center">
					<el-form
							id="product"
							:model="product"
							status-icon
							:rules="rules"
							ref="product"
							label-width="100px"
							class="demo-ruleForm"
							v-cloak
							style="width: 400px"
							element-loading-spinner="el-icon-loading"
							element-loading-background="rgba(0, 0, 0, 0.8)"
					>
						<el-form-item label="商品名" prop="name">
							<el-input clearable type="text"
									  v-model.trim="product.name"
									  autocomplete="off" name="name"></el-input>
						</el-form-item>
						<el-form-item label="价格" prop="price">
							<el-input clearable v-model.number="product.price"
									  prefix-icon="el-icon-unlock"
									  autocomplete="off" name="price"></el-input>
						</el-form-item>
						<el-form-item label="库存" prop="stock">
							<el-input clearable
									  v-model.number="product.stock"
									  prefix-icon="el-icon-unlock"
									  autocomplete="off" name="stock"></el-input>
						</el-form-item>
						<el-form-item label="品牌" prop="brandId">
							<el-select filterable v-model="product.brandId" name="brandId">
								<el-option v-for="brand in brands" :key="brand.id"
										   :label="brand.brandName" :value="brand.id">

								</el-option>
							</el-select>
						</el-form-item>
						<el-form-item label="描述" prop="description">
							<el-input clearable
									  v-model.trim="product.description"
									  prefix-icon="el-icon-unlock"
									  autocomplete="off" name="description"></el-input>
						</el-form-item>
						<el-form-item label="一级分类" prop="oneId">
							<!--						"-->
							<el-select filterable clearable v-model="product.oneId"
									   @change="getProductCategoryListByParentId(product.oneId)">
								<el-option v-for="categoryOne in categoryOneList" :key="categoryOne.id"
										   :label="categoryOne.name"
										   :value="categoryOne.id">

								</el-option>
							</el-select>
						</el-form-item>
						<el-form-item label="二级分类" prop="twoId">
							<el-select filterable clearable ref="twoId" v-model="product.twoId"
									   @change="getProductCategoryThirdListByParentId(product.twoId)"
							>
								<el-option v-for="categoryTwo in categoryTwoList" :key="categoryTwo.id"
										   :label="categoryTwo.name"
										   :value="{value:categoryTwo.id,label:categoryTwo.name}">
								</el-option>
							</el-select>
						</el-form-item>

						<el-form-item label="三级分类" prop="categoryLevelId">
							<el-select filterable clearable ref="threeId" name="categoryLevelId" v-model="product.categoryLevelId">
								<el-option v-for="categoryThree in categoryThreeList" :key="categoryThree.id"
										   :label="categoryThree.name" :value="categoryThree.id">
								</el-option>
							</el-select>
						</el-form-item>
						<el-form-item label="商品图片">
							<el-upload
									class="avatar-uploader"
									action="#"
									:show-file-list="false"
									:before-upload="beforeAvatarUpload"
									:http-request="handleChange"
							>
								<img v-if="imageUrl" width="100px" height="80px"
									 :src="imageUrl" class="avatar" alt=""/>
								<i v-else class="el-icon-plus avatar-uploader-icon"></i>

							</el-upload>

						</el-form-item>
						<el-form-item>
							<el-button type="primary" @click="submitForm('product')">提交</el-button>
							<el-button @click="back">返回</el-button>
						</el-form-item>
					</el-form>
				</div>
			</div>
		</div>
		<!--End 用户中心 End-->
		<!--Begin Footer Begin -->
		<div class="b_btm_bg b_btm_c">
			<div class="b_btm">
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b1.png" width="62" height="62"/></td>
						<td><h2>正品保障</h2>正品行货 放心购买</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b2.png" width="62" height="62"/></td>
						<td><h2>满38包邮</h2>满38包邮 免运费</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b3.png" width="62" height="62"/></td>
						<td><h2>天天低价</h2>天天低价 畅选无忧</td>
					</tr>
				</table>
				<table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
					   cellspacing="0" cellpadding="0">
					<tr>
						<td width="72"><img src="../../images/b4.png" width="62" height="62"/></td>
						<td><h2>准时送达</h2>收货时间由你做主</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="b_nav">
			<dl>
				<dt><a href="#">新手上路</a></dt>
				<dd><a href="#">售后流程</a></dd>
				<dd><a href="#">购物流程</a></dd>
				<dd><a href="#">订购方式</a></dd>
				<dd><a href="#">隐私声明</a></dd>
				<dd><a href="#">推荐分享说明</a></dd>
			</dl>
			<dl>
				<dt><a href="#">配送与支付</a></dt>
				<dd><a href="#">货到付款区域</a></dd>
				<dd><a href="#">配送支付查询</a></dd>
				<dd><a href="#">支付方式说明</a></dd>
			</dl>
			<dl>
				<dt><a href="#">会员中心</a></dt>
				<dd><a href="#">资金管理</a></dd>
				<dd><a href="#">我的收藏</a></dd>
				<dd><a href="#">我的订单</a></dd>
			</dl>
			<dl>
				<dt><a href="#">服务保证</a></dt>
				<dd><a href="#">退换货原则</a></dd>
				<dd><a href="#">售后服务保证</a></dd>
				<dd><a href="#">产品质量保证</a></dd>
			</dl>
			<dl>
				<dt><a href="#">联系我们</a></dt>
				<dd><a href="#">网站故障报告</a></dd>
				<dd><a href="#">购物咨询</a></dd>
				<dd><a href="#">投诉与建议</a></dd>
			</dl>
			<div class="b_tel_bg">
				<a href="#" class="b_sh1">新浪微博</a>
				<a href="#" class="b_sh2">腾讯微博</a>
				<p>
					服务热线：<br/>
					<span>400-123-4567</span>
				</p>
			</div>
			<div class="b_er">
				<div class="b_er_c"><img src="../../images/er.gif" width="118" height="118"/></div>
				<img src="../../images/ss.png"/>
			</div>
		</div>
		<div class="btmbg">
			<div class="btm">
				备案/许可证编号：蜀ICP备12009302号-1-www.dingguagua.com Copyright © 2015-2018 尤洪商城网 All Rights
				Reserved.
				复制必究 , Technical Support: Dgg Group <br/>
				<img src="../../images/b_1.gif" width="98" height="33"/><img src="../../images/b_2.gif" width="98"
																			 height="33"/><img
					src="../../images/b_3.gif"
					width="98" height="33"/><img
					src="../../images/b_4.gif" width="98" height="33"/><img src="../../images/b_5.gif" width="98"
																			height="33"/><img src="../../images/b_6.gif"
																							  width="98" height="33"/>
			</div>
		</div>
		<!--End Footer End -->
	</div>
</div>
<script src="../../utils/parseCookie.js"></script>

<script type="module">
	import {getProductByDataBase, addProduct, getProductByName, updateProductFileId} from '/api/product.js';
	import {addFile, modifyFile} from '/api/file.js';
	import {getBrandList} from '/api/brand.js';
	import {exitSystem, getUser} from "../../api/user.js";

	import {
		getProductCategoryListByParentId,
		getProductCategoryList,
		getOneIdByChild,
		getSecondIdByChild,
		getCategoryThreeListByThird,
		getSecondIdListByChild,
		getProductCategory,
	} from "/api/category.js";

	new Vue({
		el: '#root',
		data: function () {
			const checkName = async (rule, value, callback) => {
				if (!value) {
					return callback(new Error('不能为空'));
				}
				if (value.length < 2 || value.length > 6) {
					return callback(new Error('长度在2-6位'));
				}
				const {data} = await getProductByName(this.product);
				console.log(data)
				if (data != null) {
					if (data.id != this.product.id) {
						return callback(new Error('商品名已经存在!'));
					}
				}

				callback();
			};

			const checkStock = (rule, value, callback) => {
				if (!value) {
					return callback(new Error('不能为空'));
				}
				// setTimeout(() => {
				if (!Number.isInteger(value)) {
					callback(new Error('请输入数字值'));
				} else {
					if (value < 1 || value > 1000) {
						callback(new Error('请输入1-1000的库存'));
					} else {
						callback();
					}
				}
				// }, 1000);
			};
			const checkPrice = (rule, value, callback) => {
				if (!value) {
					return callback(new Error('不能为空'));
				}
				// setTimeout(() => {
				if (!Number.isInteger(value)) {
					callback(new Error('请输入数字值'));
				} else {
					if (value < 1 || value > 39999) {
						callback(new Error('请输入1-39999的价格'));
					} else {
						callback();
					}
				}
				// }, 1000);
			};
			return {
				product: {
					name: '',
				},
				oneIdByChild: 0,
				secondIdByChild: 0,
				categoryListByParentId: [],
				loading: true,
				ranks: [],
				departments: [],
				brands: [],
				page: {},
				categoryOneList: [],
				categoryTwoList: [],
				categoryThreeList: [],
				imageUrl: "",
				filePojo: {},
				user: {},
				rules: {
					name: [
						{required: true, message: '请输入商品名', trigger: 'blur'},
						{
							validator: checkName,
							trigger: 'blur'
						}
					],
					price: [
						{required: true, message: '请输入价格', trigger: 'blur'},
						{
							validator: checkPrice,
							trigger: 'blur'
						}
					],
					stock: [
						{required: true, message: '请输入库存', trigger: 'blur'},
						{
							validator: checkStock,
							trigger: 'blur'
						}
					],
					brandId: [
						{required: true, message: '请选择品牌', trigger: 'change'}

					],
					oneId: [
						{required: true, message: '请选择一级分类', trigger: 'change'}
					],
					twoId: [
						{required: true, message: '请选择二级分类', trigger: 'change'}

					],
					categoryLevelId: [
						{required: true, message: '请选择三级分类', trigger: 'change'}

					],
					description: [
						{required: true, message: '请输入描述', trigger: 'blur'},
						{
							min: 2, max: 20, message: '长度在2-20位', trigger: 'blur'
						}
					],

				}
			};
		},
		methods: {
			async submitForm(formName) {
				this.$refs[formName].validate(async (valid) => {
					if (valid) {
						let formData = new FormData(document.getElementById("product"))
						formData.set("brandId", this.product.brandId);
						formData.set("categoryLevelId", this.product.categoryLevelId);
						formData.set("goodsFile", this.product.filePath)
						const productResult = await addProduct(formData)
						this.filePojo.filePath = encodeURIComponent(productResult.data.filePath);
						this.filePojo.productId = productResult.data.id;
						const fileResult = await addFile(this.filePojo);
						if (productResult.code == "200") {
							this.product.id = productResult.data.id;
							this.product.fileId = fileResult.data.id;
							const {code} = await updateProductFileId(this.product)
							if (code == "200") {
								this.$message({
									message: '添加成功',
									type: 'success',
									center: 'true',
								})
								window.location.href = "ProductList.html";

							}

						} else {
							this.$message.error('添加失败')
						}
					} else {
						console.log('error submit!!');
						return false;
					}
				});
			},
			back() {
				window.location.href = "ProductList.html";
			},
			async getProductByDataBase() {
				let id = window.location.search.substring(4);
				const {data} = await getProductByDataBase(id)
				this.product = data;
				this.loading = false;
				await this.getSecondIdListByChild();
			},
			async getPicPathById() {
				return "http://localhost:5173/nginx/product/downloadProductImg?id=" + window.location.search.substring(4);

			},
			async getBrandList() {
				const {data} = await getBrandList();
				this.brands = data;
			},
			async getCategoryOneList() {
				let product = {type: 1};
				var page = {};
				let {data} = await getProductCategoryList(product, page);
				this.categoryOneList = data.categoryList
			},
			async getSecondIdListByChild() {
				let {data} = await getSecondIdListByChild(this.product.categoryLevelId);
				this.categoryThreeList = data
			},
			async getSecondIdByChild() {
				const {data} = await getSecondIdByChild(this.product.categoryLevelId);
				console.log(data)
				this.secondIdByChild = data;
			},
			async getOneIdByChild() {
				const {data} = await getOneIdByChild(this.product.categoryLevelId);
				this.oneIdByChild = data;
			},
			async getProductCategoryListByParentId(id) {
				const {data} = await getProductCategoryListByParentId(id);
				this.$delete(this.product, 'twoId');
				this.$delete(this.product, 'categoryLevelId');
				this.categoryListByParentId = data;
				this.categoryTwoList = [{id: 0, name: ''}];
				this.categoryThreeList = [{id: 0, name: ''}];
				this.categoryTwoList = this.categoryListByParentId.categoryTwoList
				this.categoryThreeList = this.categoryListByParentId.categoryThreeList
			},
			async getProductCategoryThirdListByParentId(params) {
				const {data} = await getCategoryThreeListByThird(params.value);
				this.$delete(this.product, 'categoryLevelId');
				this.categoryThreeList = data;
			},
			async handleChange(req) {
				this.imageUrl = URL.createObjectURL(req.file);
				this.product.filePath = req.file;
			},
			async beforeAvatarUpload(file) {
				const isJPG = file.type === "image/jpeg";
				const isPNG = file.type === "image/png";
				const isLt2M = file.size / 1024 / 1024 < 2;
				if (file.size == 0) {
					this.$message.error("请上传文件!");
				}
				if (!isJPG && !isPNG) {
					this.$message.error("上传头像图片只能是 JPG或png 格式!");
				}
				if (!isLt2M) {
					this.$message.error("上传头像图片大小不能超过 2MB!");
				}
				return isJPG || isPNG && isLt2M;
			},

			async exitSystem() {
				if (confirm("确认退出登录吗?")) {
					const {code} = await exitSystem();
					if (code == "200") {
						// window.location.href = "../login/Login.html"
						window.history.replaceState(null, "", "../login/Login.html");
						window.history.go(0)
						this.user = {};

					}
				}
			},
			async getUser() {
				const {data} = await getUser(this.user);
				this.user = data;
			},
		},
		async mounted() {
			this.user = {};
			let roleId = parseCookie("roleId");
			let loginName = parseCookie("loginName");
			if (loginName != null && loginName != '') {
				this.user.loginName = loginName;
				await this.getUser();
			}
			await this.getBrandList();
			await this.getCategoryOneList();

		},
	})

</script>


</body>
</html>